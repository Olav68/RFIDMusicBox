<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>Ola's magiske spilleboks</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        h1 { color: #333; }
        table { width: 100%; border-collapse: collapse; margin-top: 1em; }
        th, td { border: 1px solid #ccc; padding: 0.5em; text-align: left; }
        .ready { color: green; font-weight: bold; }
        .downloading { color: orange; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .button-delete { color: white; background: red; border: none; padding: 0.4em 0.8em; cursor: pointer; }
        .button-new { background: lightgray; border: none; padding: 0.4em 0.8em; cursor: pointer; }
        .button-play { background: green; color: white; border: none; padding: 0.4em 0.8em; cursor: pointer; }
        .timeline { margin-top: 2em; background: #f9f9f9; padding: 1em; border-radius: 5px; border: 1px solid #ccc; }
    </style>
</head>
<body>

<div id="rfid-status" style="font-size: 1.2em; margin-bottom: 1em;">
    ğŸ”„ Laster status...
</div>
<div id="status-timestamp" style="font-size: 0.9em; color: #666;"></div>

<script>
function updateRFIDStatus() {
    fetch('/status')
        .then(res => res.json())
        .then(data => {
            const div = document.getElementById("rfid-status");
            const timestamp = document.getElementById("status-timestamp");
            if (!data.rfid) {
                div.innerHTML = "ğŸ“­ Ingen RFID skannet ennÃ¥.";
                timestamp.innerHTML = "";
                return;
            }
            const color = data.status === "ready" ? "ğŸŸ¢" : "ğŸ”´";
            const text = data.status === "ready" ? "klar til avspilling" : "ikke koblet eller mangler fil";
            div.innerHTML = `${color} Siste RFID: <b>${data.rfid}</b> (${text})`;
            timestamp.innerHTML = "â±ï¸ Oppdatert: " + new Date().toLocaleTimeString();
        })
        .catch(() => {
            document.getElementById("rfid-status").innerText = "âŒ Klarte ikke hente status.";
        });
}
setInterval(updateRFIDStatus, 3000);
updateRFIDStatus();
</script>

<h1>Ola's magiske spilleboks</h1>

<form action="/add_url" method="post">
    <label for="url">Lim inn YouTube URL (Sjekk om URL inneholder ordet "list" dersom det er en spilleliste):</label><br>
    <input type="text" id="url" name="url" required style="width: 60%">
    <button type="submit">ğŸ’¾ Legg til ny sang</button>>
</form>
<!--
<form action="/simulate_rfid" method="post" style="margin-top:1em;">
    <label for="rfid">Test RFID:</label>
    <input type="text" name="rfid" required>
    <button type="submit">ğŸ§ª Simuler RFID-skudd</button>
</form>
-->
<p><strong>IP-adresse:</strong> <code>{{ ip }}</code> eller <code>http://magicmusic.local</code></p>


<form method="post" action="/stop" style="margin-top: 1em;">
  <button type="submit" style="background: red; color: white; padding: 0.6em 1em; font-size: 1.2em; border: none; border-radius: 6px;">
  ğŸŸ¥ Stopp
</button>
</form>

<form method="post" action="/set_default_device" style="margin-top: 1em;">
  <label for="device_name">Velg standard lydenhet:</label>
  <select name="device_name">
    {% for device in audio_devices %}
      <option value="{{ device.name }}">{{ device.friendly }}</option>
    {% endfor %}
  </select>
  <button type="submit">ğŸ’¾ Lagre som standard</button>
</form>

<form action="/set_volume" method="post" style="margin-top: 1em;">
    <label for="volume">Volum (%):</label>
    <input type="number" name="volume" min="0" max="150" step="5" value="80">
    <button type="submit">ğŸš Sett volum</button>
</form>

<table>
    <thead>
        <tr>
            <th>Tittel</th>
            <th>URL</th>
            <th>Status</th>
            <th>RFID</th>
            <th>Handlinger</th>
        </tr>
    </thead>
    <tbody>
    {% for sid, song in songs.items() if sid != 'last_read_rfid' %}
        <tr>
            <td>
  {% if request.args.get('edit') == sid %}
    <form method="post" action="/edit_title" style="display: inline;">
      <input type="hidden" name="song_id" value="{{ sid }}">
      <input type="text" name="new_title" value="{{ song.title }}" required>
      <button type="submit">ğŸ’¾</button>
      <a href="/">âŒ</a>
    </form>
  {% else %}
    {{ song.title if 'title' in song else 'Ukjent' }}
    <a href="/?edit={{ sid }}">âœï¸</a>
  {% endif %}
</td>
            <td><a href="{{ song.url }}" target="_blank">Link</a></td>
            <td class="{{ song.status }}">
                {{ 'âœ… Klar' if song.status == 'ready' else 'â³ Henter' if song.status == 'downloading' else 'âŒ Feil' }}
            </td>
            <td>
                {% if 'rfid' in song %}
                    {{ song.rfid }}
                    <form action="/unlink_rfid" method="post" style="display:inline">
                        <input type="hidden" name="song_id" value="{{ sid }}">
                        <button class="button-delete" type="submit">Slett</button>
                    </form>
                {% else %}
                    <form action="/link_rfid" method="post" style="display:inline">
                        <input type="hidden" name="song_id" value="{{ sid }}">
                        <button class="button-new" type="submit">Ny</button>
                    </form>
                {% endif %}
            </td>
            <td>
                <form action="/play" method="post" style="display:inline">
                    <input type="hidden" name="song_id" value="{{ sid }}">
                    <button class="button-play" type="submit">â–¶ Spill</button>
                </form>
                <form action="/delete_song" method="post" style="display:inline">
                    <input type="hidden" name="song_id" value="{{ sid }}">
                    <button class="button-delete" type="submit">ğŸ—‘ Slett</button>
                </form>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>

<div class="timeline">
    <h3>ğŸ“œ Logg</h3>
    <ul id="log-entries"></ul>
</div>

<script>
function updateLog() {
    fetch('/log')
        .then(res => res.json())
        .then(log => {
            const ul = document.getElementById("log-entries");
            ul.innerHTML = "";
            for (const entry of log) {
                const li = document.createElement("li");
                li.innerText = `${entry.time} - ${entry.entry}`;
                ul.appendChild(li);
            }
        })
        .catch(err => {
            console.error("Feil ved oppdatering av logg:", err);
        });
}

setInterval(updateLog, 3000);  // Hent hvert 3. sekund
updateLog();
</script>

</body>
</html>